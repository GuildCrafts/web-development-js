#!/usr/bin/env ruby

require 'json'
require 'logger'
require 'fileutils'
require 'front_matter_parser'

API_VERSION = 'v1'

ROOT_PATH = File.expand_path('../../', __FILE__)
SOURCE_FILES = File.join(ROOT_PATH, 'contracts', '*.md')
API_PATH = File.join(ROOT_PATH, '_api')
GOALS_API_PATH = File.join(API_PATH, API_VERSION, 'goals')

$logger = Logger.new(STDOUT)

$logger.info("Rebuilding API files...")

FileUtils.remove_dir(API_PATH)
FileUtils.mkdir_p(GOALS_API_PATH)

GOALS = Dir[ SOURCE_FILES ].map do |file|
  next if file =~ /TEMPLATE/

  parsed = FrontMatterParser.parse_file(file)

  goal = parsed.front_matter
  goal['content'] = parsed.content
  goal
end.reject(&:nil?)

$logger.info "Writing goals.json..."

goal_index_path = GOALS_API_PATH + '.json'
File.write(goal_index_path, { goals: GOALS }.to_json)

GOALS.each do |goal|
  filename = "#{goal['issueNumber']}.json"
  filepath = File.join(GOALS_API_PATH, filename)

  $logger.info "Creating goal #{filename}..."

  File.write(filepath, goal.to_json)
end
