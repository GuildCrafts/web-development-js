#!/usr/bin/env ruby

require 'json'
require 'logger'
require 'fileutils'

require_relative '../lib/goal'
require_relative '../lib/skill_group'

API_VERSION = 'v1'

ROOT_PATH = File.expand_path('../../', __FILE__)
API_PATH = File.join(ROOT_PATH, '_api', API_VERSION)

GOALS_API_PATH = File.join(API_PATH, 'goals')
SKILLS_API_PATH = File.join(API_PATH, 'skills')

def slugify(str)
  str.gsub(/[ :&]+/, '-').downcase
end

def build_goals_api
  goal_files = Dir[ File.join(ROOT_PATH, 'contracts', '*.md') ]
  goals = Goal.load_all(goal_files)

  $logger.info "Writing goals index..."
  File.write(GOALS_API_PATH + '.json', { goals: goals.map(&:metadata) }.to_json)

  goals.each do |goal|
    filename = "#{goal['issueNumber']}.json"
    filepath = File.join(GOALS_API_PATH, filename)

    $logger.info "Creating goal #{goal}..."
    File.write(filepath, goal.to_json)
  end
end

def build_skills_api
  skills_files = Dir[ File.join(ROOT_PATH, 'skills', '**', '*.yml')]

  groups = SkillGroup.load_all(skills_files)

  groups
    .group_by { |g| g['section'] }
    .each do |section|
      section_name = slugify(section[0])
      section_dir = File.join(SKILLS_API_PATH, section_name)
      section_groups = section[1]

      section_data = {
        'section' => section[0],
        'groups' => section_groups.map(&:metadata)
      }

      $logger.info "Writing section index #{section_name}..."
      File.write(section_dir + '.json', section_data.to_json)
      FileUtils.mkdir_p(section_dir)

      section_groups.each do |group|
        filename = slugify(group['group']) + '.json'
        filepath = File.join(section_dir, filename)

        $logger.info "Writing group #{group['group']}..."
        File.write(filepath, group.to_json)
      end
    end
end

if $PROGRAM_NAME == __FILE__
  $logger = Logger.new(STDOUT)

  $logger.info("Rebuilding API files...")

  FileUtils.remove_dir(API_PATH)
  FileUtils.mkdir_p(GOALS_API_PATH)
  FileUtils.mkdir_p(SKILLS_API_PATH)

  $logger.info "Building #{GOALS_API_PATH}..."
  GOALS = build_goals_api

  $logger.info "Building #{SKILLS_API_PATH}..."
  SKILLS = build_skills_api
end
